/*! For license information please see 40ebd41e946788d8f84f.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",i=o.toStringTag||"@@toStringTag";function s(e,t,n,r){return Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r})}try{s({},"")}catch(e){s=function(e,t,n){return e[t]=n}}function u(t,n,r,o){var a=n&&n.prototype instanceof f?n:f,c=Object.create(a.prototype);return s(c,"_invoke",function(t,n,r){var o=1;return function(a,c){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===a)throw c;return{value:e,done:!0}}for(r.method=a,r.arg=c;;){var i=r.delegate;if(i){var s=b(i,r);if(s){if(s===d)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(1===o)throw o=4,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=3;var u=l(t,n,r);if("normal"===u.type){if(o=r.done?4:2,u.arg===d)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=4,r.method="throw",r.arg=u.arg)}}}(t,r,new _(o||[])),!0),c}function l(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var d={};function f(){}function p(){}function m(){}var h={};s(h,a,(function(){return this}));var g=Object.getPrototypeOf,v=g&&g(g(T([])));v&&v!==n&&r.call(v,a)&&(h=v);var y=m.prototype=f.prototype=Object.create(h);function x(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function n(o,a,c,i){var s=l(e[o],e,a);if("throw"!==s.type){var u=s.arg,d=u.value;return d&&"object"==_typeof(d)&&r.call(d,"__await")?t.resolve(d.__await).then((function(e){n("next",e,c,i)}),(function(e){n("throw",e,c,i)})):t.resolve(d).then((function(e){u.value=e,c(u)}),(function(e){return n("throw",e,c,i)}))}i(s.arg)}var o;s(this,"_invoke",(function(e,r){function a(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(a,a):a()}),!0)}function b(t,n){var r=n.method,o=t.i[r];if(o===e)return n.delegate=null,"throw"===r&&t.i.return&&(n.method="return",n.arg=e,b(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),d;var a=l(o,t.i,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,d;var c=a.arg;return c?c.done?(n[t.r]=c.value,n.next=t.n,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,d):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,d)}function k(e){this.tryEntries.push(e)}function E(t){var n=t[4]||{};n.type="normal",n.arg=e,t[4]=n}function _(e){this.tryEntries=[[-1]],e.forEach(k,this),this.reset(!0)}function T(t){if(null!=t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return c.next=c}}throw new TypeError(_typeof(t)+" is not iterable")}return p.prototype=m,s(y,"constructor",m),s(m,"constructor",p),p.displayName=s(m,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,s(e,i,"GeneratorFunction")),e.prototype=Object.create(y),e},t.awrap=function(e){return{__await:e}},x(w.prototype),s(w.prototype,c,(function(){return this})),t.AsyncIterator=w,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var c=new w(u(e,n,r,o),a);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},x(y),s(y,i,"Generator"),s(y,a,(function(){return this})),s(y,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.unshift(r);return function e(){for(;n.length;)if((r=n.pop())in t)return e.value=r,e.done=!1,e;return e.done=!0,e}},t.values=T,_.prototype={constructor:_,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(E),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(e){c.type="throw",c.arg=t,n.next=e}for(var o=n.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],c=a[4],i=this.prev,s=a[1],u=a[2];if(-1===a[0])return r("end"),!1;if(!s&&!u)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=i){if(i<s)return this.method="next",this.arg=e,r(s),!0;if(i<u)return r(u),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r[0]>-1&&r[0]<=this.prev&&this.prev<r[2]){var o=r;break}}o&&("break"===e||"continue"===e)&&o[0]<=t&&t<=o[2]&&(o=null);var a=o?o[4]:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o[2],d):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),E(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var r=n[4];if("throw"===r.type){var o=r.arg;E(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={i:T(t),r:n,n:r},"next"===this.method&&(this.arg=e),d}},t}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){i=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(i)throw a}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function asyncGeneratorStep(e,t,n,r,o,a,c){try{var i=e[a](c),s=i.value}catch(e){return void n(e)}i.done?t(s):Promise.resolve(s).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){asyncGeneratorStep(a,r,o,c,i,"next",e)}function i(e){asyncGeneratorStep(a,r,o,c,i,"throw",e)}c(void 0)}))}}function getContextInfo(){return _getContextInfo.apply(this,arguments)}function _getContextInfo(){return _getContextInfo=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(window.Office&&Office.context&&Office.context.host)){e.next=24;break}if(Office.context.host!==Office.HostType.Excel||"undefined"==typeof Excel){e.next=11;break}return e.prev=2,e.next=5,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.worksheets.getActiveWorksheet()).load("name"),t.workbook.load("name"),(r=n.getUsedRange()).load("address, rowCount, columnCount, values"),e.next=7,t.sync();case 7:return o=n.name,a=t.workbook.name,e.abrupt("return","工作簿: ".concat(a,"\n工作表: ").concat(o,"\n工作表已用范围：").concat(r.address,"\n工作表已用范围的行数：").concat(r.rowCount,"\n工作表已用范围的列数：").concat(r.columnCount,"\n内容:\n").concat(JSON.stringify(r.values)));case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:case 15:return e.abrupt("return",e.sent);case 8:return e.prev=8,e.t0=e.catch(2),e.abrupt("return","【Excel上下文获取失败】：".concat(e.t0&&e.t0.message?e.t0.message:e.t0));case 11:if(Office.context.host!==Office.HostType.Word||"undefined"==typeof Word){e.next=21;break}return e.prev=12,e.next=15,Word.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.document.getSelection()).load("text"),e.next=4,t.sync();case 4:return e.abrupt("return","Word选中内容: ".concat(n.text));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 18:return e.prev=18,e.t1=e.catch(12),e.abrupt("return","【Word上下文获取失败】：".concat(e.t1&&e.t1.message?e.t1.message:e.t1));case 21:return e.abrupt("return","【暂不支持的 Office Host】");case 24:return e.abrupt("return","【模拟上下文】工作簿: 示例.xlsx\n工作表: Sheet1\n内容: A1:Hello, B1:World");case 25:case"end":return e.stop()}}),e,null,[[2,8],[12,18]])}))),_getContextInfo.apply(this,arguments)}function showError(e){if(!document.querySelector(".alert-danger")){var t=document.createElement("div");t.className="alert alert-danger",t.textContent=e;var n=document.querySelector(".input-container");n.parentNode.insertBefore(t,n),setTimeout((function(){return t.remove()}),4e3)}}function showNotification(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",n=document.createElement("div");n.className="notification notification-".concat(t),n.style.cssText="\n                position: fixed;\n                top: 50px;\n                right: 150px;\n                padding: 12px 24px;\n                background: ".concat("success"===t?"#10a37f":"#dc3545",";\n                color: white;\n                border-radius: 4px;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n                z-index: 1000;\n                animation: slideIn 0.3s ease;\n            "),n.textContent=e,document.body.appendChild(n),setTimeout((function(){n.style.animation="slideOut 0.3s ease",setTimeout((function(){return n.remove()}),300)}),3e3)}window.Office&&Office.onReady((function(e){console.log("Office.js 已初始化，Host:",e.host)})),document.addEventListener("DOMContentLoaded",(function(){hljs.highlightAll();var e=document.getElementById("messageInput"),t=document.getElementById("sendBtn"),n=document.getElementById("fileUpload"),r=document.getElementById("attachedFiles"),o=document.getElementById("messagesContainer"),a=document.getElementById("apiConfigBtn"),c=document.getElementById("apiConfigModal"),i=document.getElementById("closeApiConfigModal"),s=document.getElementById("cancelApiConfig"),u=document.getElementById("saveApiConfig"),l=document.getElementById("temperature"),d=document.getElementById("temperatureValue"),f=document.getElementById("newChatBtn"),p=document.getElementById("historyList"),m=document.getElementById("chatTitle"),h=(document.getElementById("closePreviewModal"),document.getElementById("htmlPreviewModal"),document.getElementById("promptToggleBtn")),g=document.getElementById("promptList");h.addEventListener("click",(function(){g.classList.toggle("active")})),document.querySelectorAll(".prompt-item").forEach((function(n){n.addEventListener("click",(function(){var r=n.textContent;e.value=r,e.style.height="auto",e.style.height=e.scrollHeight+"px",g.classList.remove("active"),t.disabled=!1,e.focus()}))})),document.addEventListener("click",(function(e){g.contains(e.target)||h.contains(e.target)||g.classList.remove("active")}));var v=w(),y={};function x(e){return new Promise((function(t,n){if(e.type.includes("excel")||e.name.endsWith(".xlsx")||e.name.endsWith(".xls")){var r=new FileReader;r.onload=function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(r){var o,a,c;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{o=new Uint8Array(r.target.result),a=XLSX.read(o,{type:"array"}),c="",a.SheetNames.forEach((function(e){var t=a.Sheets[e],n=XLSX.utils.sheet_to_json(t,{header:1});c+="工作表: ".concat(e,"\n"),c+=n.map((function(e){return e.join("\t")})).join("\n"),c+="\n\n"})),t(c)}catch(e){n("Excel文件读取失败: ".concat(e.message))}case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r.onerror=function(){return n("文件读取失败")},r.readAsArrayBuffer(e)}else if(e.type.includes("word")||e.name.endsWith(".docx")||e.name.endsWith(".doc")){var o=new FileReader;o.onload=function(){var r=_asyncToGenerator(_regeneratorRuntime().mark((function r(o){var a,c,i,s,u;return _regeneratorRuntime().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,a=o.target.result,"undefined"!=typeof mammoth){r.next=4;break}throw new Error("Mammoth.js库未加载");case 4:if(!e.name.endsWith(".docx")){r.next=13;break}return r.next=7,mammoth.extractRawText({arrayBuffer:a});case 7:if((i=r.sent)&&i.value){r.next=10;break}throw new Error("无法提取DOCX文件内容");case 10:c=i.value,r.next=18;break;case 13:if(!e.name.endsWith(".doc")){r.next=17;break}throw new Error("暂不支持旧版.doc格式，请转换为.docx格式");case 17:throw new Error("不支持的Word文档格式");case 18:s=c.trim().replace(/\r\n/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/\t+/g," "),u="### Word文档：".concat(e.name,"\n\n").concat(s),t(u),r.next=26;break;case 23:r.prev=23,r.t0=r.catch(0),n("Word文件读取失败: ".concat(r.t0.message));case 26:case"end":return r.stop()}}),r,null,[[0,23]])})));return function(e){return r.apply(this,arguments)}}(),o.onerror=function(){return n("文件读取失败")},o.readAsArrayBuffer(e)}else{var a=new FileReader;a.onload=function(){return t(a.result)},a.onerror=function(){return n("文件读取失败")},a.readAsText(e)}}))}function w(){return"chat-"+Date.now()}function b(){p.innerHTML="",Object.keys(y).reverse().forEach((function(e){var t=y[e],n=document.createElement("div");n.className="history-item ".concat(e===v?"active":""),n.textContent=t.title||"未命名聊天",n.addEventListener("click",(function(){k(),v=e,E(e),document.querySelectorAll(".history-item").forEach((function(e){e.classList.remove("active")})),n.classList.add("active")})),p.appendChild(n)}))}function k(){var e=Array.from(o.querySelectorAll(".message")).map((function(e){return{role:e.querySelector(".message-role").textContent,content:e.querySelector(".message-text").innerHTML}}));if(e.length>0){var t=e[0].content.replace(/<[^>]*>/g,"").substring(0,30);y[v]={title:t,messages:e},localStorage.setItem("chatHistory",JSON.stringify(y)),m.textContent=t,b()}}function E(e){var t=y[e];t&&(o.innerHTML="",m.textContent=t.title,t.messages.forEach((function(e){var t=document.createElement("div");t.className="message","用户"===e.role?t.innerHTML='\n                                <div class="avatar user-avatar">U</div>\n                                <div class="message-content">\n                                    <div class="message-role">用户</div>\n                                    <div class="message-text">'.concat(e.content,"</div>\n                                </div>\n                            "):t.innerHTML='\n                                <div class="avatar">AI</div>\n                                <div class="message-content">\n                                    <div class="message-role">DeepSeek</div>\n                                    <div class="message-text">'.concat(e.content,"</div>\n                                </div>\n                            "),o.appendChild(t)})),O(),document.querySelectorAll("pre code").forEach((function(e){hljs.highlightElement(e)})))}function _(){return T.apply(this,arguments)}function T(){return T=_asyncToGenerator(_regeneratorRuntime().mark((function a(){var c,i,s,u,l,d,f,p,m,h,g,v,y,x,w,b,E;return _regeneratorRuntime().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(c=e.value.trim()){a.next=3;break}return a.abrupt("return");case 3:if((i=document.getElementById("gradientBar")).classList.add("loading"),s=c,u=[],!j){a.next=25;break}if(!H){a.next=13;break}l=H.length>2e3?H.substring(0,2e3)+"...(已截断)":H,u.push({role:"system",content:"File content:\n".concat(l)}),a.next=25;break;case 13:return a.prev=13,a.next=16,getContextInfo();case 16:(d=a.sent)&&(f=d.length>2e3?d.substring(0,2e3)+"...(已截断)":d,u.push({role:"system",content:"Current context:\n".concat(f)})),a.next=25;break;case 20:return a.prev=20,a.t0=a.catch(13),console.error("Error getting context:",a.t0),showError("获取上下文信息失败"),a.abrupt("return");case 25:if(Array.from(o.querySelectorAll(".message")).forEach((function(e){var t=e.querySelector(".message-role").textContent,n=e.querySelector(".message-text").textContent;"用户"===t?u.push({role:"user",content:n.substring(0,8e3)}):"DeepSeek"===t&&u.push({role:"assistant",content:n.substring(0,8e3)})})),u.push({role:"user",content:c.substring(0,8e3)}),I("user",s),e.value="",e.style.height="auto",t.disabled=!0,n.value="",r.innerHTML="",H="",(p=document.createElement("div")).className="message",p.innerHTML='\n                    <div class="avatar">AI</div>\n                    <div class="message-content">\n                        <div class="message-role">DeepSeek</div>\n                        <div class="message-text" id="streamingText"></div>\n                        <div class="message-actions">\n                            <button class="msg-action-btn insert-btn" title="插入到文档">\n                                 <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6e6e80">\n        <path d="M19 12H5M5 12l7-7M5 12l7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>\n                            </button>\n                            <button class="msg-action-btn copy-btn" title="复制内容">\n                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6e6e80">\n                    <rect x="8" y="8" width="12" height="12" rx="2" stroke-width="2"/>\n                    <path d="M16 8V6a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2h2" stroke-width="2"/>\n                </svg>\n                            </button>\n                        </div>\n                    </div>\n                ',m=p.querySelector(".message-actions"),h=p.querySelector(".message-text"),m&&(null===(g=m.querySelector(".insert-btn"))||void 0===g||g.addEventListener("click",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.innerText||h.textContent,!(window.Office&&Office.context&&Office.context.document)){e.next=21;break}if(e.prev=2,Office.context.host!==Office.HostType.Word||"undefined"==typeof Word){e.next=8;break}return e.next=6,Word.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.document.getSelection().insertText(t,Word.InsertLocation.replace),e.next=3,n.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=14;break;case 8:if(Office.context.host!==Office.HostType.Excel||"undefined"==typeof Excel){e.next=13;break}return e.next=11,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.workbook.getSelectedRange().values=[[t]],e.next=4,n.sync();case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:e.next=14;break;case 13:showNotification("当前 Office 类型暂不支持插入","error");case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(2),showNotification("插入失败: "+(e.t0.message||e.t0),"error");case 19:e.next=22;break;case 21:showNotification("请在 Office 文档中使用插入功能","error");case 22:case"end":return e.stop()}}),e,null,[[2,16]])})))),null===(v=m.querySelector(".copy-btn"))||void 0===v||v.addEventListener("click",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=h.innerText||h.textContent,e.prev=1,e.next=4,navigator.clipboard.writeText(t);case 4:showNotification("内容已复制"),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),showNotification("复制失败: "+(e.t0.message||e.t0),"error");case 10:case"end":return e.stop()}}),e,null,[[1,7]])}))))),o.appendChild(p),y=p.querySelector("#streamingText"),O(),x=localStorage.getItem("apiKey")||document.getElementById("apiKey").value,w=localStorage.getItem("apiEndpoint")||document.getElementById("apiEndpoint").value,b=localStorage.getItem("model")||document.getElementById("model").value,E=localStorage.getItem("temperature")||document.getElementById("temperature").value,x){a.next=51;break}return y.innerHTML="错误: 请先配置API密钥",a.abrupt("return");case 51:return a.prev=51,a.next=54,S({apiKey:x,apiEndpoint:w,model:b,temperature:parseFloat(E),messages:u,streamingText:y,onComplete:function(){i.classList.remove("loading"),k()}});case 54:a.next=61;break;case 56:a.prev=56,a.t1=a.catch(51),i.classList.remove("loading"),console.error("API调用错误:",a.t1),showError("API请求失败: "+a.t1.message);case 61:case"end":return a.stop()}}),a,null,[[13,20],[51,56]])}))),T.apply(this,arguments)}function S(e){var t=e.apiKey,n=e.apiEndpoint,r=e.model,o=e.temperature,a=e.messages,c=e.streamingText,i=e.onComplete;!function(e){var t=e.payload,n=e.streamingText,r=e.onComplete,o="";fetch(e.url,{method:"POST",headers:e.headers,body:JSON.stringify(t)}).then((function(e){if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));var t=e.body.getReader(),a=new TextDecoder,c="";return t.read().then((function e(i){var s=i.done,u=i.value;if(!s){var l=(c+=a.decode(u,{stream:!0})).split("\n");c=l.pop();var d,f=_createForOfIteratorHelper(l);try{for(f.s();!(d=f.n()).done;){var p=d.value;if(p.startsWith("data:")&&!p.includes("[DONE]"))try{var m=JSON.parse(p.substring(5).trim());if(m.choices&&m.choices[0].delta.content){var h=m.choices[0].delta.content;o+=h,n.innerHTML=C(o),n.querySelectorAll("pre code").forEach((function(e){hljs.highlightElement(e)})),O()}}catch(e){console.error("Error parsing SSE data:",e)}}}catch(e){f.e(e)}finally{f.f()}return t.read().then(e)}null==r||r()}))})).catch((function(e){console.error("Error:",e),n.innerHTML+="<br><br>错误: ".concat(e.message)}))}({url:n,headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},payload:{model:r,messages:a,temperature:o,stream:!0,max_tokens:8e3},streamingText:c,onComplete:i})}function C(e){marked.setOptions({breaks:!0,gfm:!0,highlight:function(e,t){return t&&hljs.getLanguage(t)?hljs.highlight(e,{language:t}).value:hljs.highlightAuto(e).value}});var t=new marked.Renderer;return t.code=function(e,t){var n=hljs.getLanguage(t)?t:"plaintext",r=hljs.highlight(e,{language:n}).value,o="";return"html"===t?o='<button class="code-action-btn run">运行</button>':"python"===t?o='<button class="code-action-btn run-python">运行</button>':"javascript"===t&&(o='<button class="code-action-btn run-js">运行</button>'),'\n                        <div class="code-block">\n                            <div class="code-header">\n                                <span class="code-language">'.concat(t||"code",'</span>\n                                <div class="code-actions">\n                                    <button class="code-action-btn copy">复制</button>\n                                    ').concat(o,'\n                                </div>\n                            </div>\n                            <pre><code class="hljs language-').concat(t,'">').concat(r,"</code></pre>\n                        </div>\n                    ")},marked.parse(e,{renderer:t})}function I(e,t){var n=document.createElement("div");n.className="message";var r=C(t);if(n.innerHTML="user"===e?'\n                        <div class="avatar user-avatar">U</div>\n                        <div class="message-content">\n                            <div class="message-role"></div>\n                            <div class="message-text">'.concat(r,"</div>\n                        </div>\n                    "):'\n                        <div class="avatar">AI</div>\n                        <div class="message-content">\n                            <div class="message-role">DeepSeek</div>\n                            <div class="message-text">'.concat(r,'</div>\n                            <div class="message-actions">\n                                <button class="msg-action-btn insert-btn" title="插入到文档">\n                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                                        <path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="#10a37f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                                        <rect x="4" y="17" width="16" height="4" rx="2" fill="#10a37f" opacity="0.15"/>\n                                    </svg>\n                                </button>\n                                <button class="msg-action-btn copy-btn" title="复制内容">\n                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                                        <rect x="9" y="9" width="13" height="13" rx="2" stroke="#6e6e80" stroke-width="2"/>\n                                        <rect x="2" y="2" width="13" height="13" rx="2" fill="#6e6e80" opacity="0.12"/>\n                                    </svg>\n                                </button>\n                            </div>\n                        </div>\n                    '),o.appendChild(n),n.querySelectorAll("pre code").forEach((function(e){hljs.highlightElement(e)})),"user"!==e){var a=n.querySelector(".message-actions"),c=n.querySelector(".message-text");a.querySelector(".insert-btn").onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=c.innerText||c.textContent,!(window.Office&&Office.context&&Office.context.document)){e.next=21;break}if(e.prev=2,Office.context.host!==Office.HostType.Word||"undefined"==typeof Word){e.next=8;break}return e.next=6,Word.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.document.getSelection().insertText(t,Word.InsertLocation.replace),e.next=3,n.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=14;break;case 8:if(Office.context.host!==Office.HostType.Excel||"undefined"==typeof Excel){e.next=13;break}return e.next=11,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(n){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.workbook.getSelectedRange().values=[[t]],e.next=4,n.sync();case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:e.next=14;break;case 13:showNotification("当前 Office 类型暂不支持插入","error");case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(2),showNotification("插入失败: "+(e.t0.message||e.t0),"error");case 19:e.next=22;break;case 21:showNotification("请在 Office 文档中使用插入功能","error");case 22:case"end":return e.stop()}}),e,null,[[2,16]])}))),a.querySelector(".copy-btn").onclick=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=c.innerText||c.textContent,e.prev=1,e.next=4,navigator.clipboard.writeText(t);case 4:showNotification("内容已复制"),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),showNotification("复制失败: "+(e.t0.message||e.t0),"error");case 10:case"end":return e.stop()}}),e,null,[[1,7]])})))}return n}function O(){o.scrollTop=o.scrollHeight}!function(){var e=localStorage.getItem("chatHistory");if(e){y=JSON.parse(e),b();var t=Object.keys(y);t.length>0&&E(v=t[t.length-1])}else y={}}(),e.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),e.addEventListener("input",(function(){t.disabled=""===this.value.trim()})),n.addEventListener("change",_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,a,c,i,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.innerHTML="",t=[],!(this.files.length>0)){e.next=38;break}(n=document.createElement("div")).className="file-tag",n.textContent="正在读取文件...",r.appendChild(n),e.prev=7,o=_createForOfIteratorHelper(this.files),e.prev=9,o.s();case 11:if((a=o.n()).done){e.next=24;break}return c=a.value,(i=document.createElement("div")).className="file-tag",i.innerHTML="\n                                ".concat(c.name,' \n                                <span class="remove-file" data-file-name="').concat(c.name,'">&times;</span>\n                            '),e.next=18,x(c);case 18:s=e.sent,c.type.includes("word")||c.name.endsWith(".docx")||c.name.endsWith(".doc")?t.push({name:c.name,content:"### Word文档内容：\n\n".concat(s)}):t.push({name:c.name,content:s}),n&&r.removeChild(n),r.appendChild(i);case 22:e.next=11;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(9),o.e(e.t0);case 29:return e.prev=29,o.f(),e.finish(29);case 32:H=t.map((function(e){return"文件名: ".concat(e.name,"\n内容:\n").concat(e.content)})).join("\n\n"),e.next=38;break;case 35:e.prev=35,e.t1=e.catch(7),n&&(n.textContent="文件读取失败: ".concat(e.t1.message),n.style.color="#dc3545");case 38:case"end":return e.stop()}}),e,this,[[7,35],[9,26,29,32]])})))),r.addEventListener("click",(function(e){if(e.target.classList.contains("remove-file")){var t=e.target.getAttribute("data-file-name"),r=Array.from(n.files).filter((function(e){return e.name!==t})),o=new DataTransfer;r.forEach((function(e){return o.items.add(e)})),n.files=o.files,e.target.parentElement.remove()}})),a.addEventListener("click",(function(){c.classList.add("active")})),i.addEventListener("click",(function(){c.classList.remove("active")})),s.addEventListener("click",(function(){c.classList.remove("active")})),l.addEventListener("input",(function(){d.textContent=this.value})),u.addEventListener("click",(function(){var e=document.getElementById("apiKey").value,t=document.getElementById("apiEndpoint").value,n=document.getElementById("model").value,r=l.value;e?(localStorage.setItem("apiKey",e||"sk-kkmlqfpwanpqbfnbmyznssseikhadqzpugtizibnjmdmseus"),localStorage.setItem("apiEndpoint",t||"https://api.siliconflow.cn/v1/chat/completions"),localStorage.setItem("model",n||"deepseek-ai/DeepSeek-V3"),localStorage.setItem("temperature",r||"0.7"),c.classList.remove("active"),showNotification("API配置已保存")):showNotification("请输入API密钥","error")})),localStorage.getItem("apiKey")&&(document.getElementById("apiKey").value=localStorage.getItem("apiKey")||"sk-kkmlqfpwanpqbfnbmyznssseikhadqzpugtizibnjmdmseus",document.getElementById("apiEndpoint").value=localStorage.getItem("apiEndpoint")||"https://api.siliconflow.cn/v1/chat/completions",document.getElementById("model").value=localStorage.getItem("model")||"deepseek-chat",l.value=localStorage.getItem("temperature")||"0.7",d.textContent=l.value),o.addEventListener("click",(function(e){if(e.target.classList.contains("copy")){var t=e.target.closest(".code-block").querySelector("code");return navigator.clipboard.writeText(t.textContent).then((function(){var t=e.target.textContent;e.target.textContent="已复制!",setTimeout((function(){e.target.textContent=t}),2e3)})),void e.stopPropagation()}if(e.target.classList.contains("run")){var n=e.target.closest(".code-block").querySelector("code"),r=document.getElementById("htmlPreviewFrame"),o=new Blob([n.textContent],{type:"text/html"});return r.src=URL.createObjectURL(o),document.getElementById("htmlPreviewModal").classList.add("active"),void e.stopPropagation()}return e.target.classList.contains("run-python")?(runPythonCode(e.target.closest(".code-block").querySelector("code").textContent,e.target.closest(".message-content")),void e.stopPropagation()):e.target.classList.contains("run-js")?(runOfficeJSCode(e.target.closest(".code-block").querySelector("code").textContent,e.target.closest(".message-content")),void e.stopPropagation()):void 0})),document.getElementById("closePreviewModal").addEventListener("click",(function(){document.getElementById("htmlPreviewModal").classList.remove("active")})),t.addEventListener("click",_),e.addEventListener("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),_())})),f.addEventListener("click",(function(){k(),v=w(),m.textContent="新聊天",o.innerHTML="",b()}));var L=document.getElementById("contextEyeBtn"),H="",B=document.getElementById("eyeIcon"),j=!1;L.addEventListener("click",(function(){(j=!j)?(B.innerHTML='\n                        <path d="M1 12C2.73 7.61 7.11 4 12 4s9.27 3.61 11 8c-1.73 4.39-6.11 8-11 8S2.73 16.39 1 12z" stroke="currentColor" stroke-width="2" fill="none"/>\n                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>\n                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>\n                    ',L.style.background="transparent",L.style.color="var(--primary-color)",L.title="已开启上下文感知"):(B.innerHTML='\n                        <path d="M1 12C2.73 7.61 7.11 4 12 4s9.27 3.61 11 8c-1.73 4.39-6.11 8-11 8S2.73 16.39 1 12z" stroke="currentColor" stroke-width="2" fill="none"/>\n                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/>\n                        <line x1="4" y1="20" x2="20" y2="4" stroke="currentColor" stroke-width="2"/>\n                    ',L.style.background="transparent",L.style.color="var(--primary-color)",L.title="开启上下文感知")}))}));var style=document.createElement("style");style.textContent="\n            @keyframes slideIn {\n                from { transform: translateX(100%); opacity: 0; }\n                to { transform: translateX(0); opacity: 1; }\n            }\n            @keyframes slideOut {\n                from { transform: translateX(0); opacity: 1; }\n                to { transform: translateX(100%); opacity: 0; }\n            }\n        ",document.head.appendChild(style);var jupyterConfig={baseUrl:"https://localhost:8888/execute",token:"",kernelName:"python3"};function runPythonCode(e,t){return _runPythonCode.apply(this,arguments)}function _runPythonCode(){return(_runPythonCode=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,n){var r,o,a,c,i,s,u,l,d;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(r=document.createElement("div")).className="python-result loading",r.innerHTML="<strong>正在运行...</strong>",n.appendChild(r),e.prev=4,o=3;case 6:if(!(o>0)){e.next=24;break}return e.prev=7,e.next=10,fetch("https://localhost:8888/execute",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({code:t,timestamp:Date.now()})});case 10:return a=e.sent,e.abrupt("break",24);case 14:if(e.prev=14,e.t0=e.catch(7),0!=--o){e.next=19;break}throw e.t0;case 19:return console.warn("请求失败，剩余重试次数: ".concat(o),e.t0),e.next=22,new Promise((function(e){return setTimeout(e,1e3)}));case 22:e.next=6;break;case 24:if(a.ok){e.next=29;break}return e.next=27,a.text();case 27:throw c=e.sent,new Error("HTTP错误! 状态码: ".concat(a.status,", 响应: ").concat(c));case 29:return e.next=31,a.json();case 31:i=e.sent,r.remove(),i.success?n.innerHTML+='\n                <div class="python-result">\n                    <strong>输出:</strong>\n                    <pre><code class="hljs language-plaintext">'.concat(escapeHtml(i.output)||"[无输出]","</code></pre>\n                </div>\n            "):n.innerHTML+='\n                <div class="python-result error">\n                    <strong>错误:</strong>\n                    <pre><code class="hljs language-plaintext">'.concat(escapeHtml(i.error),"</code></pre>\n                </div>\n            "),e.next=46;break;case 36:e.prev=36,e.t1=e.catch(4),s=e.t1.message||"未知错误",u=e.t1.stack||"无堆栈信息",l="未知",d="无响应内容",e.t1.response&&(l=e.t1.response.status||"未知状态码",d=e.t1.response.statusText||"无状态文本"),console.error("Python执行错误:",{message:s,stack:u,request:{url:"https://localhost:8888/execute",method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:{code:t,timestamp:Date.now()}},response:{status:l,text:d}}),r.remove(),n.innerHTML+='\n            <div class="python-result error">\n                <strong>请求失败:</strong> '.concat(escapeHtml(s),"<br>\n                <small>请确保Python后端服务器正在运行。</small><br>\n                <details>\n                    <summary>详细信息</summary>\n                    <pre>状态码: ").concat(escapeHtml(l),"\n响应内容: ").concat(escapeHtml(d),"\n堆栈信息: ").concat(escapeHtml(u),"</pre>\n                </details>\n            </div>\n        ");case 46:hljs.highlightAll();case 47:case"end":return e.stop()}}),e,null,[[4,36],[7,14]])})))).apply(this,arguments)}function escapeHtml(e){return"string"!=typeof e&&(e=String(e||"")),e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function runOfficeJSCode(e,t){return _runOfficeJSCode.apply(this,arguments)}function _runOfficeJSCode(){return _runOfficeJSCode=_asyncToGenerator(_regeneratorRuntime().mark((function _callee16(code,messageContent){var loadingDiv,result,successMessage;return _regeneratorRuntime().wrap((function _callee16$(_context16){for(;;)switch(_context16.prev=_context16.next){case 0:if(loadingDiv=document.createElement("div"),loadingDiv.className="python-result loading",loadingDiv.innerHTML="<strong>正在运行...</strong>",messageContent.appendChild(loadingDiv),_context16.prev=4,window.Office){_context16.next=7;break}throw new Error("当前不在 Office 环境中，无法执行 Office.js 代码");case 7:return _context16.next=9,new Promise((function(e){Office.context.host?e():Office.onReady(e)}));case 9:return _context16.next=11,eval("\n            (async () => {\n                try {\n                    ".concat(code,'\n                    return "success"; // 默认返回成功\n                } catch (e) {\n                    throw e;\n                }\n            })()\n        '));case 11:if(result=_context16.sent,loadingDiv.remove(),successMessage="执行成功!",Office.context.host===Office.HostType.Excel&&(successMessage+="<br>请检查Excel工作表以查看图表效果。"),messageContent.innerHTML+='\n            <div class="python-result">\n                <strong>'.concat(successMessage,"</strong>\n            </div>\n        "),Office.context.host!==Office.HostType.Excel){_context16.next=19;break}return _context16.next=19,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.workbook.worksheets.getActiveWorksheet().getUsedRange().format.load("background"),e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 19:_context16.next=25;break;case 21:_context16.prev=21,_context16.t0=_context16.catch(4),loadingDiv.remove(),messageContent.innerHTML+='\n            <div class="python-result error">\n                <strong>执行出错:</strong>\n                <pre><code class="hljs language-plaintext">'.concat(escapeHtml(_context16.t0.message),"</code></pre>\n            </div>\n        ");case 25:case"end":return _context16.stop()}}),_callee16,null,[[4,21]])}))),_runOfficeJSCode.apply(this,arguments)}